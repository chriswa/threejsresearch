<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Proto</title>
		<style>
			html, body { margin: 0; overflow: hidden; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
        <script src="perlin.js"></script>
		<script src="three.js"></script>
		<script src="FirstPersonControls.js"></script>
		<script src="PlayerControls.js"></script>
		<script src="lodash.core.js"></script>
		<script src="Chunk.js"></script>
		<script src="Sides.js"></script>
		<script src="World.js"></script>
		<script>
			var mainTexture
			var loader = new THREE.TextureLoader();
			
			var renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio )
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			var scene  = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
			camera.position.z = 17;
			camera.position.y = 4.5;
			camera.position.x = 4;

			window.addEventListener( 'resize', () => {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}, false );

			loader.load('minecraft15.png', texture => { // e.g. loading multiple textures with promise.all: http://stackoverflow.com/questions/7919516/using-textures-in-three-js
				texture.minFilter = THREE.NearestFilter;
				texture.magFilter = THREE.NearestFilter;
				mainTexture = texture

				World.build() // requires mainTexture

				start()

				function start() {

					var clock = new THREE.Clock()
					var elapsedTime = 0

					PlayerControls.init(camera)



					var render = function () {
						requestAnimationFrame( render );

						var dt = clock.getDelta()
						elapsedTime += dt

						if (elapsedTime > 0.1) {
							elapsedTime -= 0.1
							//debugger;
							var x = Math.floor(Math.random() * Chunk.sizeX)
							var y = 3 // Math.floor(Math.random() * Chunk.sizeY)
							var z = Math.floor(Math.random() * Chunk.sizeZ)
							var middleChunk = World.chunks['0,0,0']

							var blockPos = middleChunk.getBlockPos(x, y, z)
							blockPos.setBlockData( blockPos.getBlockData() === 1 ? 0 : 1 )
						}

						PlayerControls.update(dt)
						
						World.cleanAllDirtyChunks()

						renderer.render(scene, camera)
					};

					requestAnimationFrame( render )
				}
			})
		</script>
	</body>
</html>